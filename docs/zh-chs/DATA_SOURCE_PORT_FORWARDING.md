# 透明转发端口（Port Forwarding）

## 概述

透明转发端口模式允许您在 TUI 内部将一个端口的 Modbus 数据透明地转发到另一个端口。此功能支持以下高级用例：

1. **数据转发**：将一个端口的从站转换为另一个端口的主站
2. **数据复制**：将主站数据复制到多个端口进行监控或测试
3. **协议桥接**：在不同的物理端口或虚拟连接之间桥接数据

## 何时使用透明转发端口

- **多端口场景**：当您有多个串行端口并需要在它们之间共享数据时
- **测试**：创建测试设置，其中一个端口模拟另一个端口的行为
- **监控**：将活动端口的数据复制到监控端口，而不影响原始连接
- **数据聚合**：通过从不同端口转发来组合来自多个源的数据

## TUI 配置

### 步骤 1：确保源端口正在运行

在配置端口转发之前，请确保源端口已配置并正在运行：

1. 在入口页面导航到源端口
2. 配置其 Modbus 站点（主站或从站模式）
3. 使用 `Ctrl+S` 保存配置以启用端口
4. 验证端口显示"Running ●"状态

### 步骤 2：使用透明转发配置目标端口

1. 导航到目标端口（将转发数据的端口）
2. 按 `Enter` 进入配置面板
3. 向下导航到"Enter Business Configuration"并按 `Enter`
4. 向下导航到"数据源"字段
5. 按 `Enter` 编辑数据源
6. 使用箭头键（`←` / `→`）循环浏览选项，直到到达"透明转发端口"
7. 按 `Enter` 确认

### 步骤 3：选择源端口

选择"透明转发端口"作为数据源后：

1. 向下导航到"数据源端口"字段
2. 按 `Enter` 打开端口选择器
3. 使用箭头键（`←` / `→`）浏览可用端口
4. 按 `Enter` 选择所需的源端口
5. 按 `Ctrl+S` 保存并启用转发

**注意**：如果只存在一个端口（当前端口），"数据源端口"字段将显示灰色提示"暂无其他可用端口"，按 `Enter` 将不会执行任何操作。

### 步骤 4：配置站点

即使启用了透明转发，您仍然需要在目标端口上配置至少一个站点：

1. 导航到"创建站点"
2. 配置站点 ID、寄存器类型、起始地址和寄存器长度
3. 寄存器值将自动从源端口的数据中填充

### 步骤 5：保存并启用

1. 按 `Ctrl+S` 保存配置
2. 端口将开始运行，显示"Running ●"状态
3. 源端口的数据将定期转发到此端口

## 工作原理

当启用透明转发时：

1. **后台守护进程**：TUI 为此端口生成一个专用的后台线程
2. **定期读取**：守护进程定期从源端口的全局状态中读取寄存器值
3. **状态同步**：守护进程通过内部 IPC 更新目标端口的寄存器值
4. **自动更新**：源端口的更改会自动反映在目标端口中

转发完全在 TUI 进程内部进行，无需外部网络或串行通信。

## 用例示例：多主站设置

假设您有：
- `/tmp/vcom1`：作为从站连接到物理 Modbus 设备
- `/tmp/vcom2`：您希望作为主站从 vcom1 读取

配置：

1. 配置 `/tmp/vcom1`：
   - 模式：从站
   - 配置从站以响应 Modbus 请求

2. 配置 `/tmp/vcom2`：
   - 模式：主站
   - 数据源：透明转发端口
   - 源端口：`/tmp/vcom1`
   - 配置主站

结果：`/tmp/vcom2` 将作为主站运行，但其数据来自 `/tmp/vcom1` 的从站响应，有效地转发数据。

## 用例示例：数据复制

假设您有：
- `/tmp/vcom1`：从外部 IPC 数据源读取的主端口
- `/tmp/vcom2`：需要镜像 vcom1 数据的监控端口

配置：

1. 配置 `/tmp/vcom1`：
   - 模式：主站
   - 数据源：IPC 管道（例如 `/tmp/data_feed`）
   - 配置站点

2. 配置 `/tmp/vcom2`：
   - 模式：主站
   - 数据源：透明转发端口
   - 源端口：`/tmp/vcom1`
   - 配置具有相同寄存器布局的站点

结果：两个端口显示相同的数据，vcom2 镜像 vcom1 的寄存器值。

## 限制

- **源端口必须运行**：转发工作之前，源端口必须启用
- **不能自我转发**：端口不能从自身转发
- **仅主站模式**：透明转发仅适用于主站
- **仅内部**：转发在 TUI 内部进行；外部进程不能直接转发端口

## 故障排除

### 显示"暂无其他可用端口"消息

出现此消息的原因：
- 系统中只存在一个端口（没有源端口可以转发）
- 当前端口是唯一的端口
- **解决方案**：首先添加另一个端口，配置并启用它，然后设置转发

### 数据未更新

检查：
- 源端口正在运行（显示"Running ●"状态）
- 源端口已配置站点
- 目标端口正在运行（显示"Running ●"状态）
- 两个端口使用兼容的寄存器类型和地址范围

### 选项中未显示透明转发

确保：
- 您正在配置主站（而不是从站）
- 您在 Modbus 仪表板面板中
- 您已导航到"数据源"字段

## 高级：多重转发链

您可以创建转发链：
- 端口 A → 端口 B → 端口 C

但是要小心：
- 链中的每个链接都会引入延迟
- UI 会防止循环转发（A → B → A）
- 如果使用多个转发级别，请监控性能

## 另请参阅

- [IPC 数据源](DATA_SOURCE_IPC.md) - 用于外部数据集成
- [HTTP 数据源](DATA_SOURCE_HTTP.md) - 用于基于 HTTP 的数据源
- [MQTT 数据源](DATA_SOURCE_MQTT.md) - 用于 MQTT 集成
