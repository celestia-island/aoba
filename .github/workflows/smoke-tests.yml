# Smoke tests with virtual serial ports for black-box CLI testing
# These tests validate basic functionality quickly without deep integration
name: Smoke Tests

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  smoke-test:
    name: Smoke Tests
    runs-on: ubuntu-latest
    # Only run after basic checks pass
    needs: []
    
    steps:
    - uses: actions/checkout@v4
    
    # Use stable Rust for consistent smoke test results
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
    
    # Install system dependencies including socat for virtual serial ports
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libudev-dev pkg-config libx11-dev libxcb-shape0-dev libxcb-xfixes0-dev socat
    
    # Cache Cargo registry to speed up builds
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
    
    # Build release binaries for testing
    - name: Build release binaries
      run: cargo build --release
    
    # Set up virtual serial ports using socat
    # Creates /tmp/vcom1 and /tmp/vcom2 connected to each other
    - name: Setup virtual serial ports
      run: |
        # Create virtual serial port pair
        socat -d -d pty,raw,echo=0,link=/tmp/vcom1 pty,raw,echo=0,link=/tmp/vcom2 &
        SOCAT_PID=$!
        echo "SOCAT_PID=$SOCAT_PID" >> $GITHUB_ENV
        sleep 2
        
        # Verify ports were created
        ls -la /tmp/vcom1 /tmp/vcom2
        
        # Make ports accessible (wait for socat to create them first)
        timeout 10 bash -c 'while [ ! -e /tmp/vcom1 ] || [ ! -e /tmp/vcom2 ]; do sleep 0.1; done'
        sudo chmod 666 /tmp/vcom1 /tmp/vcom2 || true
    
    # Run the dedicated smoke test binary and CLI integration tests example
    - name: Run smoke tests
      run: |
        # Run our dedicated smoke test binary
        cargo run --bin smoke_test
        
        # Run CLI integration tests example
        cargo run --example cli_integration_tests
    
    # Clean up virtual ports
    - name: Cleanup
      if: always()
      run: |
        if [ ! -z "$SOCAT_PID" ]; then
          kill $SOCAT_PID || true
        fi