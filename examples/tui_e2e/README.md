# TUI E2E Testing with insta and TestBackend

## Overview

The TUI E2E tests have been refactored to use `ratatui::TestBackend` for rendering and `insta` for snapshot testing. This eliminates the need to spawn real TUI processes with `expectrl` and parse terminal output with `vt100`.

## Architecture

### Key Components

1. **Renderer Module** (`src/renderer.rs`)
   - Renders TUI directly to a `TestBackend`
   - Converts ratatui `Buffer` to string representation
   - No process spawning required

2. **Executor Module** (`src/executor.rs`)
   - Executes TOML workflow definitions
   - Generates `insta` snapshots for verification steps
   - Supports two modes: `--screen-capture-only` and DrillDown (default)

3. **Snapshot Directory** (`snapshots/`)
   - Stores `.snap` files generated by `insta`
   - Organized by workflow ID and step description
   - Version controlled for regression testing

## Testing Modes

### 1. Screen Capture Only Mode (`--screen-capture-only`)

In this mode:
- Mock state is manipulated directly
- No keyboard input simulation
- Tests rendering logic with specific state
- Faster execution, good for UI regression tests

### 2. DrillDown Mode (default)

In this mode:
- Simulates keyboard input events
- Tests interactive workflows
- Uses TestBackend for rendering (not real processes)
- Keyboard events processed through test IPC channel (TODO: full implementation)

## Usage

### Running Tests

Use the provided script to run all TUI E2E tests:

```bash
# Run all TUI rendering tests (screen-capture mode)
./scripts/run_ci_locally.sh --workflow tui-rendering

# Run all TUI drilldown tests (keyboard simulation mode)
./scripts/run_ci_locally.sh --workflow tui-drilldown

# Run specific module
./scripts/run_ci_locally.sh --workflow tui-rendering --module single_station_master_coils

# Run all tests
./scripts/run_ci_locally.sh --workflow all
```

Or run directly with cargo:

```bash
# Run in screen-capture mode
cargo run --package tui_e2e -- --screen-capture-only --module single_station_master_coils

# Run in drilldown mode (default)
cargo run --package tui_e2e -- --module single_station_master_coils

# List available modules
cargo run --package tui_e2e -- --list
```

### Reviewing Snapshots

When tests run for the first time or the UI changes, `insta` will generate new snapshots:

```bash
# Review all pending snapshots
cargo insta review

# Accept all snapshots
cargo insta accept

# Reject all snapshots
cargo insta reject
```

### Test Workflow

1. **First Run**: Snapshots are created but test fails (expected)
2. **Review**: Use `cargo insta review` to inspect snapshots
3. **Accept**: Use `cargo insta accept` if snapshots look correct
4. **Commit**: Commit the `.snap` files to version control
5. **Future Runs**: Tests compare against committed snapshots

## How It Works

### Rendering Process

```rust
// 1. Initialize TUI global status
ensure_status_initialized()?;

// 2. Create TestBackend with specified dimensions
let backend = TestBackend::new(120, 40);
let mut terminal = Terminal::new(backend)?;

// 3. Render TUI to backend
terminal.draw(|frame| {
    aoba::tui::render_ui_for_testing(frame)?;
})?;

// 4. Convert buffer to string
let screen_content = buffer_to_string(terminal.backend().buffer());
```

### Snapshot Generation

```rust
// 5. Create snapshot with insta
insta::with_settings!({
    snapshot_path => "../snapshots",
    prepend_module_to_snapshot => false,
}, {
    insta::assert_snapshot!(snapshot_name, screen_content);
});
```

## Benefits

1. **No Process Spawning**: Faster test execution, no cleanup needed
2. **Pure Rendering Tests**: Tests UI rendering logic independently  
3. **Easy Review**: Visual diffs with `cargo insta review`
4. **Version Control**: Snapshots tracked in git for regression detection
5. **Deterministic**: No timing issues or race conditions
6. **Keyboard Simulation**: DrillDown mode supports interactive testing

## Current Status

### Implemented
- âœ… TestBackend-based rendering (no process spawning)
- âœ… Snapshot testing with insta
- âœ… Screen-capture mode for static UI tests
- âœ… DrillDown mode structure for interactive tests

### In Progress
- ðŸš§ Test IPC channel for keyboard event simulation in DrillDown mode
- ðŸš§ Mock state synchronization for complex state setups
- ðŸš§ Full keyboard input processing in DrillDown mode

## Future Enhancements

### Test IPC Channel (Priority)

Implement a test-specific IPC channel for DrillDown mode:

```rust
// TODO: Create test IPC channel
// 1. Define test IPC message types
// 2. Start test IPC listener in TUI when in test mode
// 3. Send keyboard events through channel
// 4. Process events through normal input handler
// 5. Allow real-time status updates and rendering
```

### Mock State Synchronization

To support workflows that need specific TUI states:

```rust
// Set mock state before rendering
set_mock_state("ports[0].name", json!("/tmp/vcom1"))?;
set_mock_state("ports[0].enabled", json!(true))?;

// Sync mock state to TUI global status
sync_mock_state_to_tui_status()?;

// Render with updated state
render_tui_to_string(120, 40)?;
```

## Migration from Old Tests

### Before (with expectrl/vt100)

```rust
// Spawn TUI process
let mut session = spawn_tui_process()?;

// Send keys
session.send("\r")?; // Enter

// Capture and parse terminal
let screen = capture_screen(&mut session)?;
assert!(screen.contains("Expected text"));
```

### After (with TestBackend/insta)

```rust
// Set up state (if needed)
set_mock_state("page", json!("entry"))?;

// Render
let screen = render_tui_to_string(120, 40)?;

// Snapshot
insta::assert_snapshot!("test_entry_page", screen);

// Also verify text
assert!(screen.contains("Expected text"));
```

## Troubleshooting

### Snapshot Mismatches

If snapshots don't match:

1. Review with `cargo insta review`
2. Check if UI changes are intentional
3. Update snapshots with `cargo insta accept`
4. Commit updated `.snap` files

### Missing Snapshots Directory

If snapshots aren't created:

```bash
mkdir -p examples/tui_e2e/snapshots
```

### Test Failures

Common issues:

- **Text not found**: Check if mock state is set correctly
- **Empty screen**: TUI status may not be initialized
- **Wrong page**: Verify page state in mock data

## References

- [insta Documentation](https://insta.rs/)
- [ratatui TestBackend](https://docs.rs/ratatui/latest/ratatui/backend/struct.TestBackend.html)
- [copilot-instructions.md](../../.github/copilot-instructions.md) - TUI E2E testing guidelines
