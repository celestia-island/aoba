# Data Source - Port Forwarding Mode
# Test ID: data_source_port_forwarding
# Setup: vcom1 (IPC source providing data) -> vcom2 (Port Forwarding from vcom1)
# Station: vcom1 Master ID=1, Type=Holding, Address=0x0000, Length=10
#          vcom2 Master ID=2, Type=Holding, Address=0x0000, Length=10 (forwarding from vcom1)
#
# Test Focus:
# - Configure first port (vcom1) with IPC data source
# - Configure second port (vcom2) with Port Forwarding from vcom1
# - Verify port forwarding selector shows available ports
# - Simulate external data source feeding data to vcom1
# - Verify data appears correctly on vcom2 through forwarding (3 rounds)
#
# Test Data (3 Rounds - simulated as external data feed to vcom1):
# Round 1 - Sequential: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
# Round 2 - Reverse: [9, 8, 7, 6, 5, 4, 3, 2, 1, 0]
# Round 3 - Custom: [0x1111, 0x2222, 0x3333, 0x4444, 0x5555, 0x6666, 0x7777, 0x8888, 0x9999, 0xAAAA]

[manifest]
id = "data_source_port_forwarding"
description = "Master mode with Port Forwarding data source"
station_id = 2
register_type = "Holding"
start_address = 0x0000
register_count = 10
mode = "master"

init_order = [
  "setup_ports",
  "navigate_to_entry",
  "setup_vcom1_ipc",
  "setup_vcom2_forwarding",
  "verify_forwarding_setup",
  "simulate_data_feed_round1",
]

recycle_order = ["simulate_data_feed_round2", "simulate_data_feed_round3"]

# Step 0: Setup both ports in mock state
[[workflow.setup_ports]]
description = "Initialize mock state with two ports"
mock_path = "$.port_order"
mock_set_value = ["/tmp/vcom1", "/tmp/vcom2"]

[[workflow.setup_ports]]
description = "Initialize vcom1 port structure"
mock_path = "$.ports['/tmp/vcom1']"
mock_set_value = { enabled = false, state = { type = "free" }, modbus_masters = [], modbus_slaves = [], master_source = { type = "manual" } }

[[workflow.setup_ports]]
description = "Initialize vcom2 port structure"
mock_path = "$.ports['/tmp/vcom2']"
mock_set_value = { enabled = false, state = { type = "free" }, modbus_masters = [], modbus_slaves = [], master_source = { type = "manual" } }

# Step 1: Navigate to Entry page
[[workflow.navigate_to_entry]]
description = "Initialize mock state for entry page"
mock_path = "$.page"
mock_set_value = { type = "entry" }

[[workflow.navigate_to_entry]]
description = "Initial navigation to entry page"
verify = "/tmp/vcom1"

[[workflow.navigate_to_entry]]
verify = "/tmp/vcom2"

# Step 2: Setup vcom1 with IPC data source
[[workflow.setup_vcom1_ipc]]
description = "Select vcom1 port"
key = "Enter"

[[workflow.setup_vcom1_ipc]]
description = "Switch to config panel"
mock_path = "$.page"
mock_set_value = { type = "config_panel", selected_port = 0 }

[[workflow.setup_vcom1_ipc]]
description = "Navigate to Business Configuration"
key = "Down"
times = 2

[[workflow.setup_vcom1_ipc]]
description = "Enter Modbus panel"
key = "Enter"

[[workflow.setup_vcom1_ipc]]
description = "Switch to Modbus dashboard"
mock_path = "$.page"
mock_set_value = { type = "modbus_dashboard", selected_port = 0 }

[[workflow.setup_vcom1_ipc]]
description = "Navigate to Data Source Kind"
key = "Down"
times = 2

[[workflow.setup_vcom1_ipc]]
description = "Enter edit mode for Data Source Kind"
key = "Enter"

[[workflow.setup_vcom1_ipc]]
description = "Cycle to IpcPipe (Manual->MqttServer->HttpServer->IpcPipe)"
key = "Char(l)"
times = 3

[[workflow.setup_vcom1_ipc]]
description = "Confirm Data Source Kind"
key = "Enter"

[[workflow.setup_vcom1_ipc]]
description = "Update master source to IpcPipe in mock state"
mock_path = "$.ports['/tmp/vcom1'].master_source"
mock_set_value = { type = "ipc_pipe", path = "" }

[[workflow.setup_vcom1_ipc]]
description = "Navigate to Data Source Value"
key = "Down"

[[workflow.setup_vcom1_ipc]]
description = "Enter edit mode for IPC path"
key = "Enter"

[[workflow.setup_vcom1_ipc]]
description = "Type IPC pipe path"
input = "string"
value = "/tmp/test_ipc_pipe"

[[workflow.setup_vcom1_ipc]]
description = "Confirm IPC path"
key = "Enter"

[[workflow.setup_vcom1_ipc]]
description = "Update IPC path in mock state"
mock_path = "$.ports['/tmp/vcom1'].master_source.path"
mock_set_value = "/tmp/test_ipc_pipe"

[[workflow.setup_vcom1_ipc]]
description = "Navigate to AddLine"
key = "Down"

[[workflow.setup_vcom1_ipc]]
description = "Create station on vcom1"
key = "Enter"

[[workflow.setup_vcom1_ipc]]
description = "Initialize master station on vcom1"
mock_path = "$.ports['/tmp/vcom1'].modbus_masters"
mock_set_value = [
  { station_id = 1, register_type = "Holding", start_address = 0, register_count = 10, registers = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0] },
]

[[workflow.setup_vcom1_ipc]]
description = "Save vcom1 configuration"
key = "Ctrl+S"

[[workflow.setup_vcom1_ipc]]
description = "Enable vcom1 port"
mock_path = "$.ports['/tmp/vcom1'].enabled"
mock_set_value = true

[[workflow.setup_vcom1_ipc]]
description = "Set vcom1 port state to running"
mock_path = "$.ports['/tmp/vcom1'].state"
mock_set_value = { type = "occupied_by_this" }

[[workflow.setup_vcom1_ipc]]
description = "Return to entry page"
key = "Escape"
times = 3

[[workflow.setup_vcom1_ipc]]
description = "Switch to entry page"
mock_path = "$.page"
mock_set_value = { type = "entry" }

# Step 3: Setup vcom2 with Port Forwarding from vcom1
[[workflow.setup_vcom2_forwarding]]
description = "Navigate down to vcom2"
key = "Down"

[[workflow.setup_vcom2_forwarding]]
description = "Select vcom2 port"
key = "Enter"

[[workflow.setup_vcom2_forwarding]]
description = "Switch to config panel for vcom2"
mock_path = "$.page"
mock_set_value = { type = "config_panel", selected_port = 1 }

[[workflow.setup_vcom2_forwarding]]
description = "Navigate to Business Configuration"
key = "Down"
times = 2

[[workflow.setup_vcom2_forwarding]]
description = "Enter Modbus panel"
key = "Enter"

[[workflow.setup_vcom2_forwarding]]
description = "Switch to Modbus dashboard for vcom2"
mock_path = "$.page"
mock_set_value = { type = "modbus_dashboard", selected_port = 1 }

[[workflow.setup_vcom2_forwarding]]
description = "Navigate to Data Source Kind"
key = "Down"
times = 2

[[workflow.setup_vcom2_forwarding]]
description = "Enter edit mode for Data Source Kind"
key = "Enter"

[[workflow.setup_vcom2_forwarding]]
description = "Cycle to PortForwarding (Manual->..->PortForwarding)"
key = "Char(l)"
times = 4

[[workflow.setup_vcom2_forwarding]]
description = "Confirm Data Source Kind as PortForwarding"
key = "Enter"

[[workflow.setup_vcom2_forwarding]]
description = "Update master source to PortForwarding in mock state"
mock_path = "$.ports['/tmp/vcom2'].master_source"
mock_set_value = { type = "port_forwarding", source_port = "" }

[[workflow.setup_vcom2_forwarding]]
description = "Verify Port Forwarding data source is shown"
verify = "Port Forwarding"

[[workflow.setup_vcom2_forwarding]]
description = "Navigate to Source Port selector"
key = "Down"

[[workflow.setup_vcom2_forwarding]]
description = "Enter edit mode for source port selection"
key = "Enter"

[[workflow.setup_vcom2_forwarding]]
description = "Select vcom1 as source (should be the only available port)"
key = "Enter"

[[workflow.setup_vcom2_forwarding]]
description = "Update source port to vcom1 in mock state"
mock_path = "$.ports['/tmp/vcom2'].master_source.source_port"
mock_set_value = "/tmp/vcom1"

[[workflow.setup_vcom2_forwarding]]
description = "Verify source port is shown"
verify = "/tmp/vcom1"

[[workflow.setup_vcom2_forwarding]]
description = "Navigate to AddLine"
key = "Down"

[[workflow.setup_vcom2_forwarding]]
description = "Create station on vcom2"
key = "Enter"

[[workflow.setup_vcom2_forwarding]]
description = "Initialize master station on vcom2"
mock_path = "$.ports['/tmp/vcom2'].modbus_masters"
mock_set_value = [
  { station_id = 2, register_type = "Holding", start_address = 0, register_count = 10, registers = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0] },
]

[[workflow.setup_vcom2_forwarding]]
description = "Save vcom2 configuration"
key = "Ctrl+S"

[[workflow.setup_vcom2_forwarding]]
description = "Enable vcom2 port"
mock_path = "$.ports['/tmp/vcom2'].enabled"
mock_set_value = true

[[workflow.setup_vcom2_forwarding]]
description = "Set vcom2 port state to running"
mock_path = "$.ports['/tmp/vcom2'].state"
mock_set_value = { type = "occupied_by_this" }

# Step 4: Verify forwarding setup
[[workflow.verify_forwarding_setup]]
description = "Verify vcom1 is using IPC data source"
mock_verify_path = "$.ports['/tmp/vcom1'].master_source.type"
mock_verify_value = "ipc_pipe"

[[workflow.verify_forwarding_setup]]
description = "Verify vcom2 is using Port Forwarding data source"
mock_verify_path = "$.ports['/tmp/vcom2'].master_source.type"
mock_verify_value = "port_forwarding"

[[workflow.verify_forwarding_setup]]
description = "Verify vcom2 is forwarding from vcom1"
mock_verify_path = "$.ports['/tmp/vcom2'].master_source.source_port"
mock_verify_value = "/tmp/vcom1"

# Step 5: Simulate external data feed to vcom1 - Round 1 (Sequential: 0-9)
[[workflow.simulate_data_feed_round1]]
description = "Simulate IPC pipe feeding data to vcom1 - Round 1"
mock_path = "$.ports['/tmp/vcom1'].modbus_masters[0].registers"
mock_set_value = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]

[[workflow.simulate_data_feed_round1]]
description = "Verify vcom1 has the data"
mock_verify_path = "$.ports['/tmp/vcom1'].modbus_masters[0].registers"
mock_verify_value = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]

[[workflow.simulate_data_feed_round1]]
description = "Simulate port forwarding daemon copying data to vcom2"
mock_path = "$.ports['/tmp/vcom2'].modbus_masters[0].registers"
mock_set_value = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]

[[workflow.simulate_data_feed_round1]]
description = "Verify vcom2 receives forwarded data"
mock_verify_path = "$.ports['/tmp/vcom2'].modbus_masters[0].registers"
mock_verify_value = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]

[[workflow.simulate_data_feed_round1]]
description = "Verify data appears on screen for vcom2"
verify = "0x0000              0x0000 0x0001 0x0002 0x0003"

# Step 6: Simulate external data feed - Round 2 (Reverse: 9-0)
[[workflow.simulate_data_feed_round2]]
description = "Simulate IPC pipe feeding data to vcom1 - Round 2"
mock_path = "$.ports['/tmp/vcom1'].modbus_masters[0].registers"
mock_set_value = [9, 8, 7, 6, 5, 4, 3, 2, 1, 0]

[[workflow.simulate_data_feed_round2]]
description = "Simulate port forwarding daemon copying data to vcom2"
mock_path = "$.ports['/tmp/vcom2'].modbus_masters[0].registers"
mock_set_value = [9, 8, 7, 6, 5, 4, 3, 2, 1, 0]

[[workflow.simulate_data_feed_round2]]
description = "Verify vcom2 receives forwarded data"
mock_verify_path = "$.ports['/tmp/vcom2'].modbus_masters[0].registers"
mock_verify_value = [9, 8, 7, 6, 5, 4, 3, 2, 1, 0]

[[workflow.simulate_data_feed_round2]]
description = "Verify data appears on screen for vcom2"
verify = "0x0000              0x0009 0x0008 0x0007 0x0006"

# Step 7: Simulate external data feed - Round 3 (Custom pattern)
[[workflow.simulate_data_feed_round3]]
description = "Simulate IPC pipe feeding data to vcom1 - Round 3"
mock_path = "$.ports['/tmp/vcom1'].modbus_masters[0].registers"
mock_set_value = [0x1111, 0x2222, 0x3333, 0x4444, 0x5555, 0x6666, 0x7777, 0x8888, 0x9999, 0xAAAA]

[[workflow.simulate_data_feed_round3]]
description = "Simulate port forwarding daemon copying data to vcom2"
mock_path = "$.ports['/tmp/vcom2'].modbus_masters[0].registers"
mock_set_value = [0x1111, 0x2222, 0x3333, 0x4444, 0x5555, 0x6666, 0x7777, 0x8888, 0x9999, 0xAAAA]

[[workflow.simulate_data_feed_round3]]
description = "Verify vcom2 receives forwarded data"
mock_verify_path = "$.ports['/tmp/vcom2'].modbus_masters[0].registers"
mock_verify_value = [0x1111, 0x2222, 0x3333, 0x4444, 0x5555, 0x6666, 0x7777, 0x8888, 0x9999, 0xAAAA]

[[workflow.simulate_data_feed_round3]]
description = "Verify data appears on screen for vcom2"
verify = "0x0000              0x1111 0x2222 0x3333 0x4444"
